parameters:
  - name: projectName
    displayName: Name of the Project to build
    type: string

  - name: projectVersion
    displayName: Target build version
    type: string

  - name: mavenGoals
    displayName: "Override Maven goals (default: deploy)"
    type: string
    default: deploy

  - name: mavenOptions
    displayName: Additional Maven Options
    type: string
    default:

steps:
  - bash: |
      if [ -z "$PROJECT_NAME" ]; then
        echo "##vso[task.logissue type=error;]Missing template parameter \"projectName\""
        echo "##vso[task.complete result=Failed;]"
      fi
      if [ -z "$PROJECT_VERSION" ]; then
        echo "##vso[task.logissue type=error;]Missing template parameter \"projectVersion\""
        echo "##vso[task.complete result=Failed;]"
      fi
    env:
      PROJECT_NAME: ${{ parameters.projectName }}
      PROJECT_VERSION: ${{ parameters.projectVersion }}
    displayName: Check for required parameters

  # Save a copy of the original POM file because JaCoCo modifies it, which breaks caching
  - script: cp pom.xml pom.xml.orig
    displayName: Save original pom.xml

  # Maven Cache
  - task: Cache@2
    displayName: Cache Maven local repo
    inputs:
      key: 'maven | "$(Agent.OS)" | **/pom.xml.orig' # Use original, unaltered pom file as key in Cache
      restoreKeys: |
        maven | "$(Agent.OS)"
        maven
      path: $(MAVEN_CACHE_FOLDER)

  # Maven build, test
  - task: Maven@3
    displayName: 'Build & Unit Test'
    inputs:
      mavenPomFile: 'pom.xml'
      mavenOptions: '-Xmx3072m $(MAVEN_OPTS)'
      mavenAuthenticateFeed: true
      skipEffectivePom: true
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '$(JDK_VERSION)'
      jdkArchitectureOption: 'x64'
      publishJUnitResults: true
      goals: ${{ parameters.mavenGoals }}
      codeCoverageToolOption: JaCoCo
      testResultsFiles: '**/surefire-reports/TEST-*.xml'
      options: '-Drevision=${{parameters.projectVersion}} ${{ parameters.mavenOptions }}'
